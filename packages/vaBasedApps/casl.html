<!DOCTYPE html>
<!--
  ~ /* ------------------------------------------------------------------------------------
  ~  * Copyright (c) SAS Institute Inc.
  ~  *  Licensed under the Apache License, Version 2.0 (the "License");
  ~  * you may not use this file except in compliance with the License.
  ~  * You may obtain a copy of the License at
  ~  *
  ~  * http://www.apache.org/licenses/LICENSE-2.0
  ~  *
  ~  *  Unless required by applicable law or agreed to in writing, software
  ~  * distributed under the License is distributed on an "AS IS" BASIS,
  ~  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  * See the License for the specific language governing permissions and
  ~ * limitations under the License.
  ~ ----------------------------------------------------------------------------------------*/
  ~
  -->

<html lang="en">
<head>
    <meta charset="UTF-8">

    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js"></script>

    <script src="https://unpkg.com/restaf-uicomponents/dist/restaf-uicomponents.js"></script>
    <script src="https://unpkg.com/restaf@dev/dist/restaf.min.js"></script> 
  
    <style>
        .container {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            min-height: 800px;
        }
        .elabel{
            display: inline-block;
           
            clear: left;
            width: 250px;
            text-align: right;
        }
        .einput {
            display: inline-block;
        }
        .div1 {
            border: 1px solid black;
            background: lightskyblue;

        }
        .div2 {
            border: 1px solid black;
            background: lightskyblue;
            height: 200px;
        }
    </style>

<script>

      let store   = restaf.initStore({casProxy: true});
      let session = null;
      let runSAS  = null;
      let id = 0;
      let href = window.location.origin;
      console.log(href);
      function setup() {
          console.log('initialization done');
      }

      async function sasexec(){
        debugger;
        let p = {
           authType: 'server',
           host: window.location.origin
         }
        let msg = await store.logon(p);
        console.log(msg);
        debugger;
        let {casManagement} = await store.addServices('casManagement');
        let servers = await store.apiCall(casManagement.links('servers'));
        let casserver = servers.itemsList(0);
        session = await store.apiCall(servers.itemsCmd(casserver, 'createSession'));
        console.log(JSON.stringify(session.links('execute'), null, 4));                                      

        debugger;
        id = id + 1;
        let casl = `
		action datastep.runCode/
		single='YES'
		code='data casuser.a; id=${id}; x=id*10;run;';
                run;
             action datastep.runCode /
               single='YES'
               code = 'data public.testfilter1(append=YES); set casuser.a;run;';

            action table.fetch r=result /
                table ={caslib='casuser' name='b'};
                run;
                send_response(result);
	    `;

        p = {
            action: 'sccasl.runCasl',
            data  : {code: casl}
        };
        console.log(p);
        debugger;
        let r =  await store.runAction(session,p);
        return r; 
 
     }

   
    
    function runDemo() {
        sasexec()
        .then ( (r) => {
              console.log( 'run completed' );
              let props = {
                    store  : store,
                    folder : r
              }
            rafuip.CasOutput( props, '#result' );
         })
        .catch( err => {
            console.log(JSON.stringify(err, null, 4) );
            document.getElementById('result').innerHTML = JSON.stringify(err, null, 4);
        });
}
</script>
</head>
<body onload="setup()">
    <div>
        <form>
            <input type="button" id="run" value="Run" onclick="runDemo()" >
            <p>&nbsp;</p>
            <input type="text" id="msg" length="80"> 
        </form>
    </div>
<p>&nbsp;</p>
<div id="container" class="container">
<pre id="result"> </pre>
</div>
</body>
</html>
`
